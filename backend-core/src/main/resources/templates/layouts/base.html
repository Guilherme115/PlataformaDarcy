<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title layout:title-pattern="$CONTENT_TITLE - Plataforma Darcy">Plataforma Darcy</title>

    <link rel="icon" type="image/x-icon" th:href="@{/img/onda.ico?v=2}">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/img/onda.ico?v=2}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'serif': ['Merriweather', 'serif'],
                        'mono': ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        'darcy-yellow': '#fbbf24',
                        'darcy-red': '#dc2626',
                        'darcy-purple': '#7e22ce',
                        'paper': '#fdfbf7'
                    },
                    boxShadow: {
                        'hard': '6px 6px 0px 0px black',
                        'hard-sm': '3px 3px 0px 0px black',
                    }
                }
            }
        }
    </script>

    <style>
        .htmx-indicator {
            display: none;
            opacity: 0;
            transition: opacity 200ms ease-in;
        }

        .htmx-request .htmx-indicator {
            display: flex;
            opacity: 1;
        }

        .htmx-request.htmx-indicator {
            display: flex;
            opacity: 1;
        }

        .btn-action {
            transition: all 0.1s;
            cursor: pointer;
        }

        .btn-action:active {
            transform: translate(2px, 2px);
            box-shadow: none;
        }
    </style>

    <th:block layout:fragment="head-extras"></th:block>

</head>

<body th:class="${bodyClass != null ? bodyClass : 'bg-[#e5e5e5] text-black font-sans flex flex-col min-h-screen'}"
    style="background-image: radial-gradient(#a3a3a3 1px, transparent 1px); background-size: 20px 20px;">

    <div th:replace="~{fragments/loader :: global-loader}"></div>

    <div th:replace="~{fragments/nav :: global-nav}"></div>

    <main layout:fragment="content" class="flex-1 w-full h-full"></main>

    <script>
        lucide.createIcons();
        document.body.addEventListener('htmx:afterSwap', function (evt) {
            lucide.createIcons();
        });

        // ========== PROGRESS BAR LOADER ==========
        const progressContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        let progressTimeout = null;
        let progressInterval = null;
        let currentProgress = 0;

        function startProgress() {
            // Only show after 150ms delay (fast loads won't trigger it)
            progressTimeout = setTimeout(() => {
                currentProgress = 0;
                progressBar.style.width = '0%';
                progressContainer.classList.add('active');

                // Animate progress (slow down as it approaches 90%)
                progressInterval = setInterval(() => {
                    if (currentProgress < 90) {
                        currentProgress += (90 - currentProgress) * 0.1;
                        progressBar.style.width = currentProgress + '%';
                    }
                }, 100);
            }, 150);
        }

        function finishProgress() {
            clearTimeout(progressTimeout);
            clearInterval(progressInterval);

            if (progressContainer.classList.contains('active')) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    progressBar.style.width = '0%';
                    currentProgress = 0;
                }, 200);
            }
        }

        // Show progress on link click (except HTMX and external links)
        document.addEventListener('click', function (e) {
            const link = e.target.closest('a');
            if (link &&
                link.href &&
                !link.href.startsWith('javascript:') &&
                !link.href.startsWith('#') &&
                !link.hasAttribute('hx-get') &&
                !link.hasAttribute('hx-post') &&
                !link.hasAttribute('data-no-loader') &&
                link.target !== '_blank' &&
                link.hostname === window.location.hostname) {

                startProgress();
            }
        });

        // Show progress on form submit
        document.addEventListener('submit', function (e) {
            const form = e.target;
            if (!form.hasAttribute('hx-post') && !form.hasAttribute('hx-get') && !form.hasAttribute('data-no-loader')) {
                startProgress();
            }
        });

        // Finish progress when page loads
        window.addEventListener('pageshow', finishProgress);
        window.addEventListener('load', finishProgress);
    </script>

    <!-- Upgrade Modal (Global) -->
    <div th:replace="~{fragments/upgrade-modal :: modal}"></div>

    <!-- Pro Feature Interceptor Script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const userIsPro = /*[[${#authorization.expression('hasRole(''PRO'')')}]]*/ false;

        document.addEventListener('DOMContentLoaded', function () {
            if (!userIsPro) {
                document.body.addEventListener('click', function (e) {
                    const target = e.target.closest('.restricted-pro');
                    if (target) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof openUpgradeModal === 'function') {
                            openUpgradeModal();
                        } else {
                            alert("Esta funcionalidade Ã© exclusiva para assinantes PRO!");
                        }
                    }
                }, true); // Use capture phase to intercept early
            }
        });
        /*]]>*/
    </script>

    <th:block layout:fragment="page-scripts"></th:block>
</body>

</html>