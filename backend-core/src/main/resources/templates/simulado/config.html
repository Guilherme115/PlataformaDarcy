<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  th:with="bodyClass='flex flex-col min-h-screen text-black font-serif p-8 bg-[#e5e5e5]'">

<head>
  <title>Configurar Bateria - Darcy</title>

  <th:block layout:fragment="head-extras">
    <style>
      .option-card:has(input:checked) {
        background-color: #fef08a;
        border-color: black;
        box-shadow: 4px 4px 0px 0px black;
        transform: translate(-2px, -2px);
      }

      .custom-check:checked+div {
        background-color: black;
        border-color: black;
      }

      .custom-check:checked+div:after {
        content: '';
        display: block;
        width: 8px;
        height: 8px;
        background: white;
      }

      .topic-checkbox:checked~span {
        font-weight: 700;
      }

      .topic-checkbox:checked+div {
        background-color: black;
      }

      .topic-checkbox:checked+div:after {
        content: '‚úì';
        color: white;
        font-size: 10px;
        font-weight: 900;
      }

      .materia-chip {
        cursor: pointer;
        transition: all 0.15s;
      }

      .materia-chip.selected {
        background: black !important;
        color: white !important;
        border-color: black !important;
      }

      .slider-ia {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: linear-gradient(to right, #e5e5e5 0%, #e5e5e5 0%, #a78bfa 0%, #a78bfa 100%);
        border: 2px solid black;
      }

      .slider-ia::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: #8b5cf6;
        border: 2px solid black;
        cursor: pointer;
      }
    </style>
  </th:block>
</head>

<body>
  <div layout:fragment="content">

    <header class="max-w-6xl mx-auto w-full mb-8 flex justify-between items-end">
      <div>
        <h1 class="text-4xl font-black italic mb-2"><span class="border-b-4 border-black">MONTAR</span> <span
            class="bg-black text-white px-2">LISTA.</span></h1>
        <p class="font-mono text-xs text-gray-600 max-w-2xl">Configure sua lista personalizada combinando banco de
          quest√µes + IA.</p>
      </div>
      <a href="/simulado" class="font-mono text-xs font-bold uppercase hover:underline mb-2">Cancelar</a>
    </header>

    <form action="/simulado/gerar-hibrido" method="post" class="max-w-6xl mx-auto w-full grid grid-cols-12 gap-8">

      <div class="col-span-8 space-y-8">

        <!-- ETAPA -->
        <div class="border-2 border-black bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-gray-200 pb-2 mb-4 flex items-center gap-2">
            <i data-lucide="layers" class="w-4 h-4"></i> 1. Etapa do PAS
          </h3>
          <div class="grid grid-cols-3 gap-4">
            <label class="option-card border-2 border-gray-300 p-4 cursor-pointer transition text-center bg-gray-50">
              <input type="radio" name="etapa" value="1" class="hidden" checked onchange="carregarMaterias()">
              <span class="text-2xl font-black italic block">PAS 1</span>
            </label>
            <label class="option-card border-2 border-gray-300 p-4 cursor-pointer transition text-center bg-gray-50">
              <input type="radio" name="etapa" value="2" class="hidden" onchange="carregarMaterias()">
              <span class="text-2xl font-black italic block">PAS 2</span>
            </label>
            <label class="option-card border-2 border-gray-300 p-4 cursor-pointer transition text-center bg-gray-50">
              <input type="radio" name="etapa" value="3" class="hidden" onchange="carregarMaterias()">
              <span class="text-2xl font-black italic block">PAS 3</span>
            </label>
          </div>
        </div>

        <!-- SELE√á√ÉO DE MAT√âRIAS (M√∫ltipla) -->
        <div class="border-2 border-black bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-gray-200 pb-2 mb-4 flex items-center gap-2">
            <i data-lucide="book-open" class="w-4 h-4"></i> 2. Selecione as Mat√©rias
          </h3>
          <p class="text-[10px] font-mono text-gray-500 mb-3">*Clique para adicionar/remover mat√©rias √† sua lista</p>
          <div class="flex flex-wrap gap-2" id="materias-container">
            <p class="text-xs text-gray-400 font-mono">Carregando mat√©rias...</p>
          </div>
          <input type="hidden" name="materias" id="materias-input">
        </div>

        <!-- SELE√á√ÉO DE T√ìPICOS ESPEC√çFICOS (Opcional) -->
        <div class="border-2 border-black bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-gray-200 pb-2 mb-4 flex items-center gap-2">
            <i data-lucide="filter" class="w-4 h-4"></i> 3. T√≥picos Espec√≠ficos (Opcional)
          </h3>
          <p class="text-[10px] font-mono text-gray-500 mb-3">*Deixe vazio para incluir todos os t√≥picos das mat√©rias
            selecionadas</p>

          <div id="topicos-por-materia" class="space-y-4">
            <p class="text-center text-xs text-gray-400 font-mono mt-8">Selecione mat√©rias acima primeiro.</p>
          </div>
        </div>

      </div>

      <div class="col-span-4 space-y-6">

        <!-- QUANTIDADE TOTAL -->
        <div class="border-2 border-black bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-gray-200 pb-2 mb-6 flex items-center gap-2">
            <i data-lucide="hash" class="w-4 h-4"></i> 4. Quantidade Total
          </h3>

          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold uppercase font-mono">Total de Quest√µes</span>
              <span class="bg-black text-white px-3 py-1 font-black text-lg" id="qtd-display">20</span>
            </div>
            <input type="range" name="quantidadeTotal" id="slider-total" min="5" max="120" step="5" value="20"
              oninput="updateQuantidades()"
              class="w-full h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-black">
            <div class="flex justify-between text-[8px] font-bold uppercase mt-1 text-gray-400 font-mono">
              <span>5</span>
              <span>120</span>
            </div>
          </div>
        </div>

        <!-- PERCENTUAL COM IA -->
        <div class="border-3 border-purple-500 bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-purple-200 pb-2 mb-6 flex items-center gap-2">
            <i data-lucide="sparkles" class="w-4 h-4 text-purple-600"></i> 5. Percentual com IA
          </h3>

          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold uppercase font-mono">% Quest√µes com IA</span>
              <span class="bg-purple-600 text-white px-3 py-1 font-black text-lg" id="ia-percent-display">30%</span>
            </div>
            <input type="range" name="percentualIA" id="slider-ia" min="0" max="100" step="10" value="30"
              oninput="updateQuantidades()" class="slider-ia">
            <div class="flex justify-between text-[8px] font-bold uppercase mt-1 text-gray-400 font-mono">
              <span>0% (S√≥ Banco)</span>
              <span>100% (S√≥ IA)</span>
            </div>
          </div>

          <div class="bg-purple-50 border-2 border-purple-200 p-3 text-[10px] font-mono">
            <div class="flex justify-between mb-1">
              <span>üì¶ Do Banco:</span>
              <span class="font-bold" id="qtd-banco-display">14</span>
            </div>
            <div class="flex justify-between">
              <span>‚ú® IA Geradas:</span>
              <span class="font-bold text-purple-600" id="qtd-ia-display">6</span>
            </div>
          </div>
        </div>

        <!-- OP√á√ïES ADICIONAIS -->
        <div class="border-2 border-black bg-white p-6 shadow-hard">
          <h3 class="font-bold uppercase text-xs border-b-2 border-gray-200 pb-2 mb-6 flex items-center gap-2">
            <i data-lucide="settings" class="w-4 h-4"></i> 6. Op√ß√µes
          </h3>

          <div class="mb-6">
            <label class="text-[10px] font-bold uppercase block mb-2 font-mono">Tipos de Item</label>
            <div class="flex border border-black">
              <label
                class="flex-1 text-center py-2 text-[10px] font-bold uppercase cursor-pointer hover:bg-gray-100 border-r border-black has-[:checked]:bg-yellow-300 transition">
                <input type="radio" name="tipo" value="A" class="hidden"> Tipo A
              </label>
              <label
                class="flex-1 text-center py-2 text-[10px] font-bold uppercase cursor-pointer hover:bg-gray-100 border-r border-black has-[:checked]:bg-yellow-300 transition">
                <input type="radio" name="tipo" value="C" class="hidden"> Tipo C
              </label>
              <label
                class="flex-1 text-center py-2 text-[10px] font-bold uppercase cursor-pointer hover:bg-gray-100 has-[:checked]:bg-yellow-300 transition">
                <input type="radio" name="tipo" value="TODOS" class="hidden" checked> Todos
              </label>
            </div>
          </div>

          <div class="space-y-3">
            <input type="hidden" name="modo" id="input-modo" value="APRENDIZADO">

            <label class="flex items-center gap-3 cursor-pointer group">
              <input type="checkbox" id="chk-cronometro" onchange="toggleModo()" class="hidden custom-check">
              <div
                class="w-4 h-4 border-2 border-gray-400 group-hover:border-black transition flex items-center justify-center">
              </div>
              <span class="text-xs font-bold uppercase">Modo Cron√¥metro</span>
            </label>
          </div>
        </div>

        <!-- BOT√ÉO GERAR -->
        <div class="bg-black text-white p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,0.2)]">
          <button type="submit"
            class="w-full bg-yellow-400 text-black py-4 font-black uppercase tracking-widest hover:bg-yellow-300 transition shadow-[4px_4px_0px_0px_#333] active:translate-y-1 active:shadow-none flex items-center justify-center gap-2">
            <i data-lucide="zap" class="w-5 h-5"></i> GERAR LISTA
          </button>
          <p class="text-[9px] font-mono text-gray-400 mt-3 text-center">As quest√µes ser√£o mescladas automaticamente</p>

          <!-- BOT√ÉO PDF -->
          <button type="button" onclick="gerarPDF()"
            class="w-full bg-white text-black py-3 mt-3 font-black uppercase text-xs hover:bg-yellow-300 transition border-2 border-yellow-400 shadow-[3px_3px_0px_0px_#fbbf24] active:translate-y-1 active:shadow-none flex items-center justify-center gap-2">
            <i data-lucide="printer" class="w-4 h-4"></i> GERAR PDF PARA IMPRESS√ÉO
          </button>
        </div>

      </div>

    </form>
  </div>

  <th:block layout:fragment="page-scripts">
    <script th:inline="javascript">
      const taxonomy = JSON.parse([[${ taxonomyJson }]]);
      const materiasSelecionadas = new Set();
      const topicosSelecionados = {}; // { materia: [topicos...] }

      // === GERAR PDF PARA IMPRESS√ÉO ===
      function gerarPDF() {
        const etapa = document.querySelector('input[name="etapa"]:checked').value;
        const materias = Array.from(materiasSelecionadas).join(',');
        const topicos = Object.values(topicosSelecionados).flat();
        const quantidade = document.getElementById('quantidade-banco').value || 20;

        if (materiasSelecionadas.size === 0) {
          alert('‚ö†Ô∏è Selecione pelo menos uma mat√©ria para gerar o PDF!');
          return;
        }

        // Monta URL
        let url = `/simulado/gerar-pdf?etapa=${etapa}&quantidade=${quantidade}`;
        if (materias) url += `&materias=${encodeURIComponent(materias)}`;
        if (topicos.length > 0) url += `&topicos=${encodeURIComponent(topicos.join(','))}`;

        // Abre PDF em nova aba
        window.open(url, '_blank');
      }

      // === CARREGAR MAT√âRIAS POR ETAPA ===
      async function carregarMaterias() {
        const etapa = document.querySelector('input[name="etapa"]:checked').value;
        const container = document.getElementById('materias-container');
        container.innerHTML = '<p class="text-xs text-gray-400 font-mono">Carregando mat √©rias...</p>';
        materiasSelecionadas.clear();

        try {
          // Fetch taxonomy from API
          const response = await fetch(`/simulado/api/taxonomy?etapa=${etapa}`);
          if (!response.ok) throw new Error('Erro ao carregar taxonomia');

          const novaTaxonomy = await response.json();

          // Update global taxonomy variable
          for (let key in taxonomy) delete taxonomy[key];
          Object.assign(taxonomy, novaTaxonomy);

          // Render subject chips
          container.innerHTML = '';
          if (Object.keys(taxonomy).length === 0) {
            container.innerHTML = '<p class="text-xs text-gray-400 font-mono">Nenhuma mat√©ria cadastrada para este PAS. Configure em Admin > Taxonomia.</p>';
            return;
          }

          for (let mat in taxonomy) {
            const chip = document.createElement('div');
            chip.className = 'materia-chip px-4 py-2 border-2 border-gray-300 bg-gray-50 font-mono text-xs font-bold uppercase hover:border-yellow-400';
            chip.textContent = mat;
            chip.onclick = () => toggleMateria(chip, mat);
            container.appendChild(chip);
          }
        } catch (error) {
          console.error('Erro ao carregar mat√©rias:', error);
          container.innerHTML = '<p class="text-xs text-red-600 font-mono">Erro ao carregar. Tente novamente.</p>';
        }

        // Clear topics when changing stage
        document.getElementById('topicos-por-materia').innerHTML = '<p class="text-center text-xs text-gray-400 font-mono mt-8">Selecione mat√©rias acima primeiro.</p>';
      }

      function toggleMateria(chip, materia) {
        if (materiasSelecionadas.has(materia)) {
          materiasSelecionadas.delete(materia);
          delete topicosSelecionados[materia];
          chip.classList.remove('selected');
        } else {
          materiasSelecionadas.add(materia);
          chip.classList.add('selected');
        }

        atualizarInputMaterias();
        renderizarTopicos();
      }

      function atualizarInputMaterias() {
        document.getElementById('materias-input').value = Array.from(materiasSelecionadas).join(',');
      }

      function renderizarTopicos() {
        const container = document.getElementById('topicos-por-materia');
        container.innerHTML = '';

        if (materiasSelecionadas.size === 0) {
          container.innerHTML = '<p class="text-center text-xs text-gray-400 font-mono mt-8">Selecione mat√©rias acima primeiro.</p>';
          return;
        }

        materiasSelecionadas.forEach(mat => {
          const section = document.createElement('div');
          section.className = 'border-2 border-gray-200 p-4 bg-gray-50';

          let html = `<h4 class="font-black text-xs uppercase mb-3 border-b border-gray-300 pb-2">${mat}</h4>`;
          html += '<div class="space-y-2">';

          for (let sub in taxonomy[mat]) {
            html += `<div class="text-[10px] font-bold text-gray-500 uppercase mt-2 mb-1">${sub}</div>`;

            taxonomy[mat][sub].forEach(topico => {
              html += `
              <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-1 rounded">
                <input type="checkbox" name="topicos[]" value="${mat}:${topico}" class="hidden topic-checkbox" onchange="atualizarTopicos()">
                <div class="w-3 h-3 border-2 border-black flex items-center justify-center text-white shrink-0"></div>
                <span class="text-xs font-serif">${topico}</span>
              </label>
            `;
            });
          }

          html += '</div>';
          section.innerHTML = html;
          container.appendChild(section);
        });
      }

      function atualizarTopicos() {
        // Topicos j√° est√£o sendo enviados via checkboxes name="topicos[]"
      }

      function updateQuantidades() {
        const total = parseInt(document.getElementById('slider-total').value);
        const percentIA = parseInt(document.getElementById('slider-ia').value);

        const qtdIA = Math.round(total * percentIA / 100);
        const qtdBanco = total - qtdIA;

        document.getElementById('qtd-display').textContent = total;
        document.getElementById('ia-percent-display').textContent = percentIA + '%';
        document.getElementById('qtd-ia-display').textContent = qtdIA;
        document.getElementById('qtd-banco-display').textContent = qtdBanco;

        // Atualiza gradiente do slider
        const slider = document.getElementById('slider-ia');
        slider.style.background = `linear-gradient(to right, #e5e5e5 0%, #e5e5e5 ${percentIA}%, #a78bfa ${percentIA}%, #a78bfa 100%)`;
      }

      function toggleModo() {
        const checkbox = document.getElementById('chk-cronometro');
        document.getElementById('input-modo').value = checkbox.checked ? 'LIVRE' : 'APRENDIZADO';
      }

      // Inicializa
      document.addEventListener('DOMContentLoaded', () => {
        carregarMaterias();
        updateQuantidades();
        lucide.createIcons();
      });
    </script>
  </th:block>
</body>

</html>