<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/base}"
  th:with="bodyClass='flex flex-col min-h-screen text-black font-serif p-4 md:p-8 bg-[#e5e5e5]'">

<head>
  <title>Painel de Comando - Darcy</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="/js/admin-analytics.js" defer></script>

  <th:block layout:fragment="head-extras">
    <style>
      .card-hub {
        background: white;
        border: 3px solid black;
        box-shadow: 6px 6px 0px 0px black;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .card-hub:hover {
        transform: translate(-4px, -4px);
        box-shadow: 10px 10px 0px 0px black;
      }

      .card-hub:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0px 0px black;
      }

      .header-section {
        padding: 0.75rem;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 800;
        text-transform: uppercase;
        border-bottom: 4px solid black;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }

      .btn-action {
        border: 2px solid black;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.65rem;
        padding: 4px 12px;
        transition: all 0.1s;
        background: white;
        color: black;
        cursor: pointer;
      }

      .btn-action:hover {
        transform: translate(-2px, -2px);
        box-shadow: 3px 3px 0px black;
      }

      .btn-action:active {
        transform: translate(0, 0);
        box-shadow: 0 0 0 black;
      }

      .kpi-value {
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: -1px;
      }

      .btn-header {
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid black;
        background: white;
        transition: all 0.2s;
        box-shadow: 2px 2px 0px 0px rgba(0, 0, 0, 1);
      }

      .btn-header:hover {
        background: black;
        color: white;
        transform: translate(-1px, -1px);
        box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
      }
    </style>
  </th:block>
</head>

<body>

  <div layout:fragment="content">

    <!-- SYSTEM STATUS BAR -->
    <div
      class="max-w-7xl mx-auto w-full mb-6 flex justify-between items-center border-b-2 border-gray-400 pb-2 font-mono text-[10px] uppercase tracking-widest text-gray-600">
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span>Sistema Online ‚Ä¢ Admin Mode</span>
      </div>
      <div>Bras√≠lia, DF ‚Ä¢ <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy')}">DATA</span></div>
    </div>

    <!-- HEADER -->
    <header
      class="max-w-7xl mx-auto w-full mb-12 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
      <div class="flex items-end gap-5">
        <div class="w-20 h-20 bg-black border-4 border-black flex items-center justify-center shadow-hard shrink-0">
          <span class="font-serif font-black text-5xl text-darcy-yellow italic">D.</span>
        </div>
        <div class="mb-1">
          <div
            class="bg-red-600 text-white px-2 py-0.5 text-[10px] font-mono font-bold inline-block mb-1 uppercase tracking-wide flex items-center gap-1">
            <i data-lucide="shield" class="w-3 h-3"></i> Painel Administrativo
          </div>
          <h1 class="text-5xl md:text-6xl font-black italic tracking-tighter leading-[0.9]">COMANDO.</h1>
        </div>
      </div>

      <div class="flex flex-col items-end gap-3 w-full md:w-auto">
        <nav class="flex gap-6 font-mono text-xs font-bold uppercase tracking-wide border-b-2 border-transparent pb-1">
          <a href="/" class="hover:underline hover:text-yellow-600 transition">Voltar ao Site</a>
          <a href="/cms" class="hover:underline hover:text-purple-600 transition">CMS</a>
        </nav>
        <div class="flex items-center gap-4 bg-white border-2 border-black p-2 shadow-hard-sm">
          <div class="text-right px-2 border-r-2 border-gray-200 pr-4 mr-2">
            <span class="block font-bold text-sm uppercase font-sans">ADMINISTRADOR</span>
            <span class="block text-[10px] text-gray-500 font-mono">STATUS: ATIVO</span>
          </div>
          <div class="flex gap-2">
            <form th:action="@{/logout}" method="post">
              <button class="btn-header hover:!bg-red-600 hover:!border-red-600" title="Sair"><i data-lucide="log-out"
                  class="w-4 h-4"></i></button>
            </form>
          </div>
        </div>
      </div>
    </header>

    <!-- DATA INJECTION FOR CHARTS -->
    <script type="application/json" id="data-chart-labels" th:utext="${chart_labels}"></script>
    <script type="application/json" id="data-chart-users" th:utext="${chart_users}"></script>
    <script type="application/json" id="data-chart-simulados" th:utext="${chart_simulados}"></script>
    <script type="application/json" id="data-chart-subjects-keys" th:utext="${chart_desempenho_keys}"></script>
    <script type="application/json" id="data-chart-subjects-values" th:utext="${chart_desempenho_values}"></script>

    <main class="max-w-7xl mx-auto w-full">

      <!-- KPI ROW -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users -->
        <a href="/admin/usuarios" class="card-hub p-6 relative overflow-hidden group cursor-pointer">
          <div class="absolute right-0 top-0 p-3 opacity-5 group-hover:opacity-10 transition"><i data-lucide="users"
              class="w-20 h-20 text-black"></i></div>
          <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-1 font-mono">Total Usu√°rios</h3>
          <div class="text-4xl font-black text-black kpi-value" th:text="${kpi_users}">1,248</div>
          <div class="mt-2 text-[10px] text-green-600 font-mono border border-green-600 bg-green-50 px-1 inline-block">
            +12% essa semana</div>
          <div class="mt-3 text-[9px] font-bold uppercase text-gray-400 group-hover:text-black transition">CLIQUE PARA
            GERENCIAR ‚Üí</div>
        </a>

        <!-- Revenue (MRR) -->
        <div class="card-hub p-6 relative overflow-hidden group border-[#fbbf24]">
          <div class="absolute right-0 top-0 p-3 opacity-5 group-hover:opacity-10 transition"><i
              data-lucide="dollar-sign" class="w-20 h-20 text-yellow-500"></i></div>
          <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-1 font-mono">Receita Estimada</h3>
          <div class="text-4xl font-black text-[#c59102] kpi-value" th:text="${kpi_revenue}">R$ 45.2k</div>
          <div class="mt-2 text-[10px] text-gray-400 font-mono">Baseado em assinaturas ativas</div>
        </div>

        <!-- Active Issues -->
        <div class="card-hub p-6 relative overflow-hidden group border-red-600">
          <div class="absolute right-0 top-0 p-3 opacity-5 group-hover:opacity-10 transition"><i data-lucide="bug"
              class="w-20 h-20 text-red-500"></i></div>
          <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-1 font-mono">Issues Pendentes</h3>
          <div class="flex items-baseline gap-2">
            <span class="text-4xl font-black text-red-600 kpi-value" th:text="${kpi_bugs}">8</span>
            <span class="text-xs font-bold text-white bg-red-600 px-2 py-0.5 border-2 border-black"
              th:if="${kpi_bugs_criticos > 0}" th:text="${kpi_bugs_criticos} + ' CR√çTICOS'">2 CR√çTICOS</span>
          </div>
          <div class="mt-2 text-[10px] text-gray-400 font-mono">Requer aten√ß√£o imediata</div>
        </div>

        <!-- System Health -->
        <div
          class="card-hub p-6 relative overflow-hidden flex justify-between items-center bg-black text-white border-black">
          <div>
            <h3 class="text-[10px] font-bold uppercase text-gray-400 mb-1 font-mono">System Uptime</h3>
            <div class="text-3xl font-black text-green-400 kpi-value" th:text="${kpi_uptime}">99.9%</div>
            <h3 class="text-[10px] font-bold uppercase text-gray-400 mt-3 mb-1 font-mono">Server Load</h3>
            <div class="w-full bg-gray-700 h-2 mt-1 overflow-hidden border border-gray-600">
              <div class="bg-darcy-yellow h-full w-[40%]"></div>
            </div>
          </div>
          <div id="chart-server" class="w-[100px] h-[100px] -mr-2"></div>
        </div>
      </div>

      <!-- MAIN GRID -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

        <!-- GROWTH CHART -->
        <div class="lg:col-span-2 card-hub">
          <div class="header-section bg-black">
            <span class="flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-darcy-yellow"></i>
              GROWTH ENGINE</span>
            <div class="flex gap-2">
              <span class="text-[9px] px-2 py-0.5 bg-darcy-yellow text-black border border-black">7D</span>
              <span
                class="text-[9px] px-2 py-0.5 bg-black text-gray-500 border border-gray-700 cursor-not-allowed">30D</span>
            </div>
          </div>
          <div class="p-6 flex-1">
            <div id="chart-growth" class="w-full h-[300px]"></div>
          </div>
        </div>

        <!-- LIVE FEED -->
        <div class="card-hub border-red-600">
          <div class="header-section bg-red-600">
            <span class="flex items-center gap-2"><i data-lucide="radio" class="w-4 h-4"></i> LIVE FEED</span>
            <div class="w-3 h-3 bg-white rounded-full animate-ping"></div>
          </div>
          <div class="p-4 space-y-4 overflow-y-auto max-h-[350px] flex-1">
            <div th:each="log : ${feed}" class="flex gap-3 items-start border-b border-gray-100 pb-3 last:border-0">
              <div class="shrink-0 mt-1">
                <div th:if="${log.icon == 'user'}" class="w-3 h-3 rounded-full bg-blue-500 border-2 border-black"></div>
                <div th:if="${log.icon == 'play'}" class="w-3 h-3 rounded-full bg-yellow-500 border-2 border-black">
                </div>
                <div th:if="${log.icon == 'alert'}" class="w-3 h-3 rounded-full bg-red-500 border-2 border-black"></div>
              </div>
              <div>
                <span class="block text-[10px] font-bold uppercase text-gray-400 font-mono"
                  th:text="${log.tipo}">TIPO</span>
                <p class="text-xs font-mono text-black leading-tight" th:text="${log.desc}">Descri√ß√£o do log...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM GRID -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

        <!-- TRANSMISSION -->
        <div class="card-hub border-[#fbbf24]">
          <div class="header-section bg-[#fbbf24] text-black">
            <span class="flex items-center gap-2 font-black"><i data-lucide="radio" class="w-4 h-4"></i>
              TRANSMISS√ÉO</span>
            <a href="/admin/transmissoes"
              class="text-[9px] bg-black text-white px-2 py-0.5 hover:bg-gray-800 transition">VER TODOS</a>
          </div>
          <div class="p-4 flex flex-col gap-3 flex-1">
            <form hx-post="/admin/transmitir" hx-target="#status-msg" class="flex flex-col gap-3 flex-1">
              <input type="text" name="titulo" placeholder="T√çTULO DO ALERTA"
                class="border-2 border-black p-3 text-xs font-bold uppercase w-full outline-none focus:bg-yellow-50"
                required>

              <!-- Type Selector -->
              <select name="tipo"
                class="border-2 border-black p-3 text-xs font-bold uppercase w-full outline-none focus:bg-yellow-50 bg-white">
                <option value="INFO">üì¢ INFO - Novidade/Atualiza√ß√£o</option>
                <option value="ALERTA" selected>üîî ALERTA - Aviso Importante</option>
                <option value="EVENTO">üéâ EVENTO - Acontecimento Especial</option>
              </select>

              <textarea name="mensagem" rows="3" placeholder="MENSAGEM..."
                class="border-2 border-black p-3 text-xs font-mono w-full resize-none outline-none focus:bg-yellow-50 flex-1"
                required></textarea>
              <button type="submit"
                class="bg-black text-white py-3 text-xs font-black uppercase tracking-widest hover:bg-gray-800 flex items-center justify-center gap-2">
                <i data-lucide="send" class="w-3 h-3"></i> TRANSMITIR AGORA
              </button>
              <div id="status-msg"></div>
            </form>
          </div>
        </div>

        <!-- EXAM PERFORMANCE -->
        <div class="card-hub">
          <div class="header-section bg-purple-600">
            <span class="flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> DESEMPENHO POR
              MAT√âRIA</span>
          </div>
          <div class="p-4 flex-1">
            <div id="chart-subjects" class="w-full h-[250px]"></div>
          </div>
        </div>

        <!-- USER SEARCH -->
        <div class="card-hub">
          <div class="header-section bg-black">
            <span class="flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> BUSCAR USU√ÅRIO</span>
          </div>
          <div class="p-4 flex flex-col flex-1">
            <input type="text" placeholder="Nome, Email ou Matr√≠cula..."
              class="w-full border-2 border-black p-3 font-mono text-xs focus:bg-gray-50 outline-none uppercase font-bold mb-4"
              hx-post="/admin/usuarios/buscar-rapido" hx-trigger="keyup changed delay:500ms"
              hx-target="#resultado-busca">
            <div id="resultado-busca" class="flex-1 overflow-y-auto min-h-[100px]">
              <div class="text-center text-gray-400 text-xs italic mt-8 font-mono">Digite para buscar...</div>
            </div>
          </div>
        </div>

      </div>

      <!-- CMS SHORTCUTS -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="card-hub">
          <div class="header-section bg-black">
            <span class="flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4"></i> GEST√ÉO DE PROVAS</span>
            <span class="text-darcy-yellow text-xs" th:text="${provas.size()} + ' cadastradas'">0 cadastradas</span>
          </div>
          <div class="p-0 flex-1 overflow-y-auto max-h-[200px]">
            <table class="w-full text-left text-sm font-mono">
              <tbody class="divide-y-2 divide-gray-100">
                <tr th:each="p : ${provas}" th:if="${pStat.index < 5}"
                  class="hover:bg-yellow-50 cursor-pointer transition group"
                  th:attr="hx-get=@{/admin/detalhes/prova/{id}(id=${p.id})}" hx-target="#modal-container">
                  <td class="p-3 pl-4 font-bold group-hover:underline uppercase text-xs">
                    PAS <span th:text="${p.etapa}">3</span> - <span th:text="${p.ano}">2025</span>
                  </td>
                  <td class="p-3 text-right pr-4">
                    <span th:if="${p.ativo}"
                      class="text-green-600 border-2 border-green-600 px-1 text-[9px] font-black">ON</span>
                    <span th:unless="${p.ativo}"
                      class="text-yellow-600 border-2 border-yellow-600 px-1 text-[9px] font-black">DRAFT</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="p-4 border-t-2 border-black">
            <a href="/cms"
              class="w-full block text-center py-2 bg-black text-white text-xs font-black uppercase hover:bg-gray-800 transition">
              Acessar CMS Completo
            </a>
          </div>
        </div>

        <!-- BUGS PENDENTES -->
        <div class="card-hub border-red-600">
          <div class="header-section bg-red-600">
            <span class="flex items-center gap-2"><i data-lucide="bug" class="w-4 h-4"></i> BUG TRACKER</span>
            <span class="bg-white text-red-600 text-[10px] px-2 font-black border-2 border-black"
              th:text="${kpi_bugs_criticos} + ' CR√çTICOS'">0 CR√çTICOS</span>
          </div>
          <div class="p-4 space-y-4 max-h-[250px] overflow-y-auto flex-1">
            <div th:each="bug : ${bugsPendentes}" th:if="${bugStat.index < 4}"
              class="border-b-2 border-gray-100 pb-4 last:border-0">
              <div class="flex justify-between items-start mb-1">
                <span
                  class="bg-red-100 text-red-600 text-[9px] px-1 font-bold border border-red-600 uppercase font-mono">Sistema</span>
                <span class="text-[10px] font-mono text-gray-400">Recente</span>
              </div>
              <h4 class="font-bold text-sm mb-3 uppercase leading-tight" th:text="${bug.titulo}">ERRO NO LOGIN</h4>
              <div class="flex gap-2">
                <button class="btn-action" th:attr="hx-get=@{/admin/detalhes/bug/{id}(id=${bug.id})}"
                  hx-target="#modal-container">LOGS</button>
                <button class="btn-action border-green-600 text-green-600 hover:bg-green-600 hover:text-white"
                  th:attr="hx-post=@{/admin/bug/resolver/{id}(id=${bug.id})}" hx-target="closest div.border-b-2"
                  hx-swap="delete">RESOLVER</button>
              </div>
            </div>
            <div th:if="${#lists.isEmpty(bugsPendentes)}"
              class="text-center text-gray-400 text-xs italic font-mono py-8">
              Nenhum bug pendente. Sistema est√°vel.
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- MODAL CONTAINER (HTMX) -->
    <div id="modal-container"></div>

    <script>
      lucide.createIcons();
    </script>

  </div>
</body>

</html>